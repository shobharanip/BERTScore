import pandas as pd
from Translation_evaluator import TranslationEvaluator

# ─── CONFIG ────────────────────────────────────────────────────────────────────
INPUT_XLSX        = "/appdata/cortex/dev1/shob/your_input.xlsx"
TRANSLATION_SHEET = "translations"   # name of the sheet containing your sentences
OUTPUT_XLSX       = "/appdata/cortex/dev1/shob/combined_translation_results.xlsx"

REFERENCE_COL     = "en"
PREDICTION_COLS   = [
    "base_madlad400_translation",
    "base_helsinki_translation"
]
METRICS           = ["BLEU", "ChrF", "ChrF++"]
# ────────────────────────────────────────────────────────────────────────────────

# 1) Read all sheets into a dict
all_sheets: dict[str,pd.DataFrame] = pd.read_excel(
    INPUT_XLSX, sheet_name=None
)

# 2) Extract your translations sheet
orig_df = all_sheets.get(TRANSLATION_SHEET)
if orig_df is None:
    raise ValueError(f"Sheet '{TRANSLATION_SHEET}' not found in {INPUT_XLSX}")

# 3) Ensure reference & predictions are strings
for col in [REFERENCE_COL] + PREDICTION_COLS:
    if col not in orig_df.columns:
        raise ValueError(f"Column '{col}' not found in sheet '{TRANSLATION_SHEET}'")
    orig_df[col] = orig_df[col].fillna("").astype(str)

# 4) Run the evaluator
evaluator = TranslationEvaluator()
#   inject your cleaned DataFrame directly
evaluator._data = orig_df.copy()
evaluator.evaluate(
    prediction_cols = PREDICTION_COLS,
    reference_col   = REFERENCE_COL,
    metrics         = METRICS,
    keep_cols       = None   # None → keep *all* original columns
)

# 5) Build the combined results
det             = evaluator._detailed_results
metrics_only    = det.loc[:, det.columns.difference(orig_df.columns)]
combined_df     = pd.concat(
    [orig_df.reset_index(drop=True), metrics_only.reset_index(drop=True)],
    axis=1
)

# 6) Write out: one combined sheet + all the originals
with pd.ExcelWriter(OUTPUT_XLSX, engine="openpyxl") as writer:
    combined_df.to_excel(writer,
                         sheet_name="Combined Results",
                         index=False)

    for sheet_name, df in all_sheets.items():
        if sheet_name != TRANSLATION_SHEET:
            df.to_excel(writer,
                        sheet_name=sheet_name,
                        index=False)

print(f"✅ Wrote combined results (no duplicate cols) to: {OUTPUT_XLSX}")